<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Earn Vexaüí≤</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body{margin:0;font-family:'Poppins',sans-serif;background:#f2f2f2}
.container{max-width:380px;margin:50px auto;background:#fff;padding:30px;border-radius:18px;box-shadow:0 10px 25px rgba(0,0,0,.15)}
h2{text-align:center}
input,select{width:100%;padding:14px;margin:10px 0;border-radius:10px;border:1px solid #ccc;font-size:16px;box-sizing:border-box;}
button{cursor:pointer;font-weight:600;font-size:16px;border:none;border-radius:10px;color:#fff;}
#registerBtn{background:#2575fc;width:100%;padding:14px;margin:10px 0;}
#loginBtn{background:#6a11cb;width:100%;padding:14px;margin:10px 0;}
#status{text-align:center;font-weight:600;color:red;margin-bottom:10px;}
#appPage{display:none;min-height:100vh;background:#fff;position:relative;}
header{padding:20px;font-size:24px;font-weight:700;text-align:center;border-bottom:1px solid #ddd;}
main{padding:25px;padding-bottom:200px;font-size:18px}

/* Toggle Link Style */
.toggle-auth{text-align:center; margin-top:15px; font-size:14px; color:#555;}
.toggle-auth span{color:#2575fc; cursor:pointer; font-weight:600; text-decoration:underline;}

/* --- Password View Feature CSS --- */
.password-wrapper { position: relative; width: 100%; }
.password-wrapper input { padding-right: 45px; } /* Eye icon space */
.toggle-eye {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  font-size: 20px;
  color: #666;
  user-select: none;
}

/* Slider Styles */
.slider-container{position:relative;width:100%;max-width:350px;margin:15px auto;border-radius:18px;overflow:hidden;}
.slider-slide{display:none;width:100%;cursor:pointer;color:#fff;font-weight:700;font-size:20px;padding:50px 20px;text-align:center;border-radius:18px;box-sizing:border-box;}
.slider-slide .logo{display:block;width:50px;height:50px;margin:0 auto 10px auto;border-radius:50%;background:#fff;color:#2575fc;line-height:50px;font-size:28px;}

/* SUPPORT + PRIVACY BAR */
.support-bar{position:fixed;right:12px;bottom:300px;display:flex;flex-direction:column;gap:16px;z-index:1000;}
.support-bar a{display:flex;align-items:center;background:#f3f3f3;color:#2575fc;font-weight:700;padding:16px 22px;border-radius:18px;text-decoration:none;font-size:20px;}
.support-bar a span{margin-right:10px;font-size:28px;}

/* FOOTER */
footer{position:fixed;bottom:0;width:100%;height:140px;background:#fff;border-top:1px solid #ddd;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;padding-top:5px;}
footer .nav-buttons{display:flex;justify-content:space-around;width:100%;}
footer button{background:#f3f3f3;border:none;border-radius:22px;width:90px;height:90px;font-size:16px;font-weight:600;color:#444;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:0.3s;}
footer button span{font-size:32px;margin-bottom:5px;}
footer button.active{background:#2575fc;color:#fff;transform:scale(1.35);}

/* Wallet & Page styles */
#walletBalance{font-size:50px;font-weight:700;color:#2575fc;text-align:center;margin:20px 0;}
.withdraw-history{margin-top:20px;border-top:1px solid #ccc;padding-top:10px;font-size:20px;font-weight:600;}
.withdraw-item, .earn-link-item{margin-bottom:12px;padding:16px;border-radius:18px;background:#2575fc;color:#fff;font-weight:700;font-size:20px;text-align:center;cursor:pointer;transition:0.3s;}
.withdraw-item:hover, .earn-link-item:hover{background:#6a11cb;}
.bkash{color:#f44336;font-weight:700;}
.nagad{color:#4caf50;font-weight:700;}
.binance{color:#fbbc05;font-weight:700;}

/* EARN PAGE AD STYLES */
.ad-container { margin-bottom: 25px; text-align: center; }
.banner-ad-box { 
    background: #eef4ff; 
    border: 3px solid #2575fc; 
    border-radius: 18px; 
    padding: 20px 15px; 
    transition: 0.3s; 
    position: relative; 
    min-height: 250px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center;
}
.banner-ad-box:hover { border-color: #6a11cb; box-shadow: 0 0 15px rgba(37, 117, 252, 0.3); }
.ad-reward-tag { position: absolute; top: 10px; right: 15px; background: #ffd700; color: #000; padding: 5px 12px; font-weight: 700; border-radius: 10px; font-size: 14px; z-index: 5; }
.smart-link-box { background: #f9f9f9; border: 1px solid #6a11cb; border-radius: 12px; padding: 15px; margin: 10px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.ad-title { font-size: 24px; font-weight: 700; color: #333; }
.ad-subtitle { font-size: 14px; margin-top: 10px; color: #666; font-weight: 400; }

/* 
   BLOCKER OVERLAY:
   When this is display:block, it sits ON TOP of the iframe.
   Clicks hit this div, NOT the iframe, so NO tab opens.
*/
.click-overlay {
    display: none; 
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 100; /* High z-index to block everything */
    background: rgba(255, 255, 255, 0.4); /* Slightly visible so user knows its inactive */
    cursor: not-allowed;
    border-radius: 15px;
}

/* WALLET INPUT & BUTTON SIZE */
.big-select{font-size:24px;padding:22px;border-radius:18px;}
.withdraw-big{font-size:24px;padding:20px;border-radius:18px;width:100%;background:#2575fc;color:#fff;border:none;cursor:pointer;}

/* ONLY SIZE ADJUSTMENTS */
.big-welcome{font-size:32px;font-weight:700;}
.big-earn{font-size:28px;font-weight:700;}
.big-earn-text{font-size:22px;font-weight:700;color:#444;margin-top:15px;line-height:1.5;}
.big-profile-text{font-size:32px;margin:14px 0;font-weight:700;}
.logout{margin-top:10px;background:#ff4d4d;font-size:14px;padding:8px;width:auto;border-radius:10px;}
.profile-header {font-size:36px;font-weight:700;text-align:center;margin-bottom:20px;}

/* PRIVACY MODAL */
.modal-bg{display:none;position:fixed;top:0; left:0; width:100%; height:100%;background:rgba(0,0,0,0.6);justify-content:center; align-items:center;z-index:9999;}
.modal-content{background:#fff; padding:20px; border-radius:15px;max-width:90%; max-height:80%; overflow-y:auto;}
.modal-content h2{margin-top:0;text-align:center;}
.modal-close{display:block; text-align:center; margin-top:15px;padding:8px 16px; background:#2575fc; color:#fff;border:none; border-radius:10px; cursor:pointer;}
</style>
</head>
<body>

<div id="authPage" class="container">
  <div id="status"></div>

  <!-- Register Form -->
  <div id="registerBox">
    <h2>Register</h2>
    <input id="regName" placeholder="Full Name">
    <input id="regEmail" placeholder="Email">
    
    <!-- Password with Eye Icon -->
    <div class="password-wrapper">
      <input id="regPassword" type="password" placeholder="Password">
      <span class="toggle-eye" onclick="togglePassword('regPassword', this)">üôà</span>
    </div>
    
    <button id="registerBtn" onclick="register()">Register</button>
    <div class="toggle-auth">Already have an account? <span onclick="showLogin()">Login</span></div>
  </div>

  <!-- Login Form -->
  <div id="loginBox" style="display:none;">
    <h2>Login</h2>
    <input id="loginEmail" placeholder="Email">
    
    <!-- Password with Eye Icon -->
    <div class="password-wrapper">
      <input id="loginPassword" type="password" placeholder="Password">
      <span class="toggle-eye" onclick="togglePassword('loginPassword', this)">üôà</span>
    </div>
    
    <button id="loginBtn" onclick="login()">Login</button>
    <div class="toggle-auth">Don't have an account? <span onclick="showRegister()">Register</span></div>
  </div>
</div>

<div id="appPage">
<header>Earn Vexa üí≤</header>
<main id="mainContent"></main>

<div class="support-bar">
  <a href="https://t.me/Mahar821" target="_blank"><span>üí¨</span>Support</a>
  <a href="#" onclick="openPrivacy()"><span>üõ°Ô∏è</span>Privacy Policy</a>
</div>

<footer>
  <div class="nav-buttons">
    <button id="homeBtn" class="active" onclick="showPage('home')"><span>üè†</span>Home</button>
    <button id="earnBtn" onclick="showPage('earn')"><span>üí∞</span>Earn</button>
    <button id="walletBtn" onclick="showPage('wallet')"><span>üëõ</span>Wallet</button>
    <button id="profileBtn" onclick="showPage('profile')"><span>üë§</span>Profile</button>
  </div>
</footer>
</div>

<!-- Privacy Modal -->
<div id="privacyModal" class="modal-bg">
  <div class="modal-content">
    <h2>Privacy Policy</h2>
    <p>
      This website collects only your name and email for authentication purposes. Your balance, withdrawals, and account information are securely stored. We do not share, sell, or disclose your personal data to any unauthorized third parties.<br><br>
      We may use cookies or analytics tools to improve user experience and website performance. By using this website, you agree to our privacy terms.
    </p>
    <button class="modal-close" onclick="closePrivacy()">Close</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCHngO1wEvo-L1Grc7tGlT-uDN1lXmIlVI",
  authDomain: "earn-vexa.firebaseapp.com",
  projectId: "earn-vexa",
  storageBucket: "earn-vexa.firebasestorage.app",
  messagingSenderId: "385593303650",
  appId: "1:385593303650:web:4595e3443d978cd9a3273b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let userData = {};
let withdrawHistory = [];
let userDocListener = null;
let bannerBlurListener = null; 

const TELEGRAM_BOT_TOKEN = "8052078728:AAGk2zKjovKSHgKnqPCfaDVb1-fGeURa3Cw";
const TELEGRAM_CHAT_ID = "-100XXXXXXXXXX";

const statusEl = document.getElementById("status");

// Function to Toggle Password Visibility
function togglePassword(inputId, eyeIcon) {
  const passwordInput = document.getElementById(inputId);
  if (passwordInput.type === "password") {
    passwordInput.type = "text";
    eyeIcon.innerText = "üëÅÔ∏è"; 
  } else {
    passwordInput.type = "password";
    eyeIcon.innerText = "üôà"; 
  }
}

// Toggle Auth Pages
function showLogin() {
  document.getElementById("registerBox").style.display = "none";
  document.getElementById("loginBox").style.display = "block";
  statusEl.textContent = "";
}
function showRegister() {
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("registerBox").style.display = "block";
  statusEl.textContent = "";
}

async function register(){  
  statusEl.textContent = "";
  const name = regName.value.trim();
  const email = regEmail.value.trim();
  const password = regPassword.value;

  if(!name || !email || !password){ 
    statusEl.textContent = "‚ùå All fields are required!"; 
    return; 
  }
  if(!email.endsWith("@gmail.com")){ 
    statusEl.textContent = "‚ùå Only Gmail (@gmail.com) is allowed!"; 
    return; 
  }
  if(password.length < 6){
    statusEl.textContent = "‚ùåÔ∏èPassword should be at least 6 characters";
    return;
  }

  try{
    const res = await auth.createUserWithEmailAndPassword(email, password);
    // Password saved here so Admin Panel can see it
    await db.collection("users").doc(res.user.uid).set({
      name: name, email: email, password: password, balance: "0", isBanned: false
    });
  }catch(e){ 
    if(e.code === 'auth/email-already-in-use'){
      statusEl.textContent = "‚ùå Email already registered!";
    } else {
      statusEl.textContent = "‚ùå Error: " + e.message; 
    }
  }
}

async function login(){
  statusEl.textContent="";
  try{ await auth.signInWithEmailAndPassword(loginEmail.value,loginPassword.value); } 
  catch(e){ statusEl.textContent="‚ùå Login failed! Incorrect email or password."; }
}

async function loadApp(user){
  authPage.style.display="none";
  appPage.style.display="block";
  if(userDocListener) userDocListener();
  userDocListener = db.collection("users").doc(user.uid).onSnapshot((doc) => {
      if(doc.exists){
          userData = doc.data();
          if(userData.isBanned === true){ alert("üö´ Account Banned!"); logout(); return; }
          userData.email = user.email;
          if(document.getElementById("walletBalance")){
              document.getElementById("walletBalance").innerText = (userData.balance || 0) + " USDT";
          }
      }
  });
  try {
      const historySnap = await db.collection("withdraw_requests").where("uid","==",user.uid).get();
      withdrawHistory = historySnap.docs.map(d=>d.data());
  } catch(e) { console.log("Withdraw History Load Error:", e); }
  showPage("home");
}

let slideIndex = 0;
const slidesData = [
  {text:"Join Telegram Channel", sub:"Click to join", link:"https://t.me/Mahar821", color:"#2575fc", logo:"üì¢"},
  {text:"Telegram Support", sub:"Get help here", link:"https://t.me/earnvexa", color:"#6a11cb", logo:"üí¨"}
];
function showSlide(){
  const sliderContainer = document.querySelector(".slider-container");
  if(!sliderContainer) return;
  sliderContainer.innerHTML = '';
  const slide = document.createElement('div');
  slide.className = "slider-slide";
  slide.style.background = slidesData[slideIndex].color;
  slide.innerHTML = `<span class="logo">${slidesData[slideIndex].logo}</span>${slidesData[slideIndex].text}<br><small>${slidesData[slideIndex].sub}</small>`;
  slide.onclick = ()=>{ window.open(slidesData[slideIndex].link,'_blank'); };
  sliderContainer.appendChild(slide);
  slide.style.display = "block";
  slideIndex = (slideIndex+1)%slidesData.length;
}
setInterval(showSlide, 2500);

// --- REWARD PROCESSING (NO ALERT HERE) ---
async function processReward(taskId, rewardAmount) {
    const today = new Date().toISOString().split('T')[0];
    const uid = auth.currentUser.uid;
    const taskRef = db.collection("user_ads").doc(uid);
    
    try {
        const currentBalance = parseFloat(userData.balance || 0);
        const newBalance = (currentBalance + rewardAmount).toFixed(7);
        
        await db.collection("users").doc(uid).update({ balance: newBalance.toString() });
        
        let updateObj = {};
        updateObj[taskId] = today;
        await taskRef.set(updateObj, { merge: true });
        
        // Removed alert from here to handle it differently for Banner vs Smart Link
        return true; 
    } catch(e) {
        console.error(e);
        return false;
    }
}

// --- SMART LINK HANDLER (Alert is fine here) ---
async function handleEarn(taskId, rewardAmount, url) {
    const today = new Date().toISOString().split('T')[0];
    const uid = auth.currentUser.uid;
    
    // Check DB first
    const doc = await db.collection("user_ads").doc(uid).get();
    const data = doc.exists ? doc.data() : {};
    
    if (data[taskId] === today) {
        alert("‚ùå Already claimed today! Come back tomorrow.");
        // DO NOT open tab
        return;
    }
    
    // Add Balance & Open Link
    const success = await processReward(taskId, rewardAmount);
    if(success) {
        window.open(url, '_blank');
        alert(`‚úÖ Success! You earned ${rewardAmount} USDT.`);
    }
}

async function showPage(p){
  document.querySelectorAll("footer button").forEach(b=>b.classList.remove("active"));
  
  if(bannerBlurListener) { window.removeEventListener('blur', bannerBlurListener); bannerBlurListener = null; }

  if(p==="home"){
    mainContent.innerHTML=`<div class="big-welcome">Welcome, ${userData.name || 'User'} üëã</div>
      <div class="slider-container"></div>`;
    homeBtn.classList.add("active");
    slideIndex=0;
    showSlide();
  }

  if(p==="earn"){
    mainContent.innerHTML=`
      <div class="big-earn">Earn Balance üí∞</div>
      <p class="big-earn-text">‡¶®‡¶ø‡¶ö‡ßá ‡¶•‡¶æ‡¶ï‡¶æ Ad ‡¶ü‡¶ø‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ì‡¶™‡ßá‡¶® ‡¶π‡¶≤‡ßá ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</p>
      
      <div class="ad-container">
        <!-- Banner Box -->
        <div class="banner-ad-box" id="bannerWrapper">
            <div class="ad-reward-tag">Click Ad to Earn 0.00205 USDT</div>
            
            <!-- Adsterra Iframe -->
            <div id="ad-slot-300-250"></div>
            
            <!-- OVERLAY BLOCKER (Initially Hidden) -->
            <div id="bannerOverlay" class="click-overlay"></div>
        </div>
      </div>

      <!-- Smart Link 1 -->
      <div class="smart-link-box" onclick="handleEarn('smart1', 0.0008197, 'https://www.effectivegatecpm.com/q5tr5extmy?key=d3bd60a33be82ecf91d6d22b59cd9765')">
        <div style="font-weight:700;">Ad link 1</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>

      <!-- Smart Link 2 -->
      <div class="smart-link-box" onclick="handleEarn('smart2', 0.0008197, 'https://www.effectivegatecpm.com/kxdppwwruj?key=cc18e71b22c9889bc375099a9f4ce46f')">
        <div style="font-weight:700;">Ad link 2</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>

      <!-- Smart Link 3 -->
      <div class="smart-link-box" onclick="handleEarn('smart3', 0.0008197, 'https://www.effectivegatecpm.com/qjy3qs3cu?key=51b052bab3e5366ca575842e68a8c808')">
        <div style="font-weight:700;">Ad link 3</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>

      <!-- Smart Link 4 -->
      <div class="smart-link-box" onclick="handleEarn('smart4', 0.0008197, 'https://www.effectivegatecpm.com/cn5p8241vw?key=57ee98cb7cb7b1ac8a11dbe9802977f9')">
        <div style="font-weight:700;">Ad link 4</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>

      <!-- Smart Link 5 -->
      <div class="smart-link-box" onclick="handleEarn('smart5', 0.0008197, 'https://www.effectivegatecpm.com/ar8rd00b?key=263a5d556e491df174d3d1b33ef777e8')">
        <div style="font-weight:700;">Ad link 5</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>

      <!-- Smart Link 6 -->
      <div class="smart-link-box" onclick="handleEarn('smart6', 0.0008197, 'https://www.effectivegatecpm.com/h5k34gs4?key=2c6382d277deeb2dc4b14d58d7208caa')">
        <div style="font-weight:700;">Ad link 6</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>

      <!-- Smart Link 7 -->
      <div class="smart-link-box" onclick="handleEarn('smart7', 0.0008197, 'https://www.effectivegatecpm.com/pu2a046u?key=65d4bf395068f08f4721e90b40c0eb0d')">
        <div style="font-weight:700;">Ad link 7</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>

      <!-- Smart Link 8 -->
      <div class="smart-link-box" onclick="handleEarn('smart8', 0.0008197, 'https://www.effectivegatecpm.com/wv4q5gpa5?key=513d875d8b53c8e14716f32640770dcf')">
        <div style="font-weight:700;">Ad link 8</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>

      <!-- NEW: Smart Link 9 -->
      <div class="smart-link-box" onclick="handleEarn('smart9', 0.0008197, 'https://www.effectivegatecpm.com/aekvgnemc?key=8d627e2df3a16e8b942ff76f54f98467')">
        <div style="font-weight:700;">Ad link 9</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>

      <!-- NEW: Smart Link 10 -->
      <div class="smart-link-box" onclick="handleEarn('smart10', 0.0008197, 'https://www.effectivegatecpm.com/ezjisqjn10?key=affe0d1d6b387bc3b6cb9e71a50cb04b')">
        <div style="font-weight:700;">Ad link 10</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>

      <!-- NEW: Smart Link 11 -->
      <div class="smart-link-box" onclick="handleEarn('smart11', 0.0008197, 'https://www.effectivegatecpm.com/hmx00h1i6?key=bd643fed44ee2888b5bf4de574834539')">
        <div style="font-weight:700;">Ad link 11</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>

      <!-- NEW: Smart Link 12 -->
      <div class="smart-link-box" onclick="handleEarn('smart12', 0.0008197, 'https://www.effectivegatecpm.com/gpfqnia5i?key=a25fb881eb076c4e3b8f66007af718a3')">
        <div style="font-weight:700;">Ad link 12</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
    `;
    earnBtn.classList.add("active");

    // =============================================
    // Banner Ad Script (Adsterra + Blocker Logic)
    // =============================================

    const adContainer = document.getElementById('ad-slot-300-250');
    if(adContainer){
        adContainer.innerHTML = '';
        const s1 = document.createElement('script');
        s1.type = 'text/javascript';
        s1.text = `atOptions = { 'key' : '290468ba31574258b12173a3560e2bc8', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} };`;
        adContainer.appendChild(s1);
        const s2 = document.createElement('script');
        s2.type = 'text/javascript';
        s2.src = 'https://www.highperformanceformat.com/290468ba31574258b12173a3560e2bc8/invoke.js';
        adContainer.appendChild(s2);
    }
    
    // Banner Logic
    const overlay = document.getElementById('bannerOverlay');
    const wrapper = document.getElementById('bannerWrapper');
    const taskId = 'banner1';
    const today = new Date().toISOString().split('T')[0];
    
    const doc = await db.collection("user_ads").doc(auth.currentUser.uid).get();
    const data = doc.exists ? doc.data() : {};
    
    const enableBlocker = () => {
        overlay.style.display = 'block'; 
        overlay.onclick = (e) => {
            e.stopPropagation();
            alert("‚ùå Already claimed today!");
        };
    };

    if(data[taskId] === today) {
        enableBlocker();
    } else {
        overlay.style.display = 'none';
        let isHovering = false;
        wrapper.onmouseover = () => isHovering = true;
        wrapper.onmouseout = () => isHovering = false;
        
        const bannerBlurListener = async function() {
            if(isHovering) {
                window.removeEventListener('blur', bannerBlurListener);
                await processReward(taskId, 0.00205);
                enableBlocker();
                setTimeout(() => { alert(`‚úÖ Success! You earned 0.00205 USDT.`); }, 1000);
            }
        };
        window.addEventListener('blur', bannerBlurListener);
    }
}

  if(p==="wallet"){
    let historyHtml = withdrawHistory.map(h => {
        const dateObj = h.time && h.time.toDate ? h.time.toDate() : new Date();
        const dateStr = dateObj.toLocaleString(); 
        
        return `<div class="withdraw-item ${h.method.toLowerCase()}" style="padding: 20px 25px; text-align: left; cursor: default;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <span style="font-size: 20px; font-weight: 700; color: #fff;">${h.method}</span>
                <span style="font-size: 18px; font-weight: 700;">Status: ${h.status}</span>
            </div>
            <div style="font-size: 28px; font-weight: 700; margin-bottom: 5px;">${h.amount} USDT</div>
            <div style="font-size: 14px; font-weight: 400; opacity: 0.9;">Account: ${h.account}</div>
            <div style="font-size: 12px; font-weight: 400; opacity: 0.7; margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 5px;">Request Time: ${dateStr}</div>
        </div>`;
    }).join("");
    
    let displayBalance = userData.balance ? userData.balance : 0;
    mainContent.innerHTML=`<h2>Your Balance</h2><div id="walletBalance">${displayBalance} USDT</div>
      <h3 style="font-size:22px;font-weight:600;">Withdraw</h3>
      <select id="method" class="big-select">
        <option value="bKash">üí∏ Bkash</option>
        <option value="Nagad">üí∂ Nagad</option>
        <option value="Binance">üí≤ Binance</option>
      </select>
      <input id="account" placeholder="Account / Wallet Address" class="big-select">
      <input id="amount" placeholder="Amount (Min 0.50)" type="number" class="big-select">
      <button class="withdraw-big" onclick="withdraw()">Request Withdraw</button>
      <div class="withdraw-history"><h4 style="font-size:22px;font-weight:600;">Withdraw History</h4>${historyHtml||"<i style='font-size:20px;font-weight:600;'>No history</i>"}</div>`;
    walletBtn.classList.add("active");
  }

  if(p==="profile"){
    mainContent.innerHTML=`<h2 class="profile-header">Profile</h2>
      <p class="big-profile-text"><b>Name:</b> ${userData.name}</p>
      <p class="big-profile-text"><b>Email:</b> ${userData.email}</p>
      <button class="logout" onclick="logout()">Logout</button>`;
    profileBtn.classList.add("active");
  }
}

async function withdraw(){
  const methodEl = document.getElementById("method");
  const accountEl = document.getElementById("account");
  const amountEl = document.getElementById("amount");
  let reqAmount = parseFloat(amountEl.value);
  let currentBalance = parseFloat(userData.balance || 0);

  if(!methodEl.value || !accountEl.value || !reqAmount){ alert("‚ùå All fields required!"); return; }
  if(reqAmount <= 0){ alert("‚ùå Invalid Amount!"); return; }
  if(reqAmount > currentBalance){ alert("‚ùå Insufficient Balance!"); return; }

  if(!confirm(`Withdraw ${reqAmount} USDT to ${methodEl.value}?`)) return;
  try{
    let newBalance = (currentBalance - reqAmount).toFixed(7);
    const newWithdrawRequest = {
      uid: auth.currentUser.uid, method: methodEl.value, account: accountEl.value, amount: reqAmount.toString(), status: "Pending", time: new Date()
    };
    
    await db.collection("users").doc(auth.currentUser.uid).update({ balance: newBalance.toString() });
    await db.collection("withdraw_requests").add(newWithdrawRequest);
    
    const message=`üí∞ New Withdraw Request\nUser: ${userData.name}\nMethod: ${methodEl.value}\nAccount: ${accountEl.value}\nAmount: ${reqAmount} USDT`;
    fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}`);
    alert("‚úÖ Request Submitted!");
    
    const historySnap = await db.collection("withdraw_requests").where("uid","==",auth.currentUser.uid).get();
    withdrawHistory = historySnap.docs.map(d=>d.data());
    showPage("wallet");
  } catch(e){ 
    alert("‚ùå Failed: " + e.message); 
    console.error(e);
  }
}

function logout(){ auth.signOut(); location.reload(); }
function openPrivacy(){ document.getElementById("privacyModal").style.display="flex"; }
function closePrivacy(){ document.getElementById("privacyModal").style.display="none"; }

let appLoaded = false;
auth.onAuthStateChanged(u=>{
  if(u){ if(!appLoaded){ appLoaded = true; loadApp(u); } 
  } 
  else { appLoaded = false; authPage.style.display="block"; appPage.style.display="none"; }
});
</script>
</body>
</html>
