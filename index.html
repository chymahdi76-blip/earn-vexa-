<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Earn Vexaüí≤</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* --- BASE STYLES --- */
body{margin:0;font-family:'Poppins',sans-serif;background:#f8f9fd; color: #333;}
.container{max-width:380px;margin:50px auto;background:#fff;padding:30px;border-radius:24px;box-shadow:0 15px 35px rgba(0,0,0,.1)}
h2{text-align:center; color:#333;}
input,select{width:100%;padding:16px;margin:10px 0;border-radius:12px;border:1px solid #eee;background:#fafafa;font-size:16px;box-sizing:border-box;outline:none;transition:0.3s;}
input:focus, select:focus{border-color:#2575fc;background:#fff;}
button{cursor:pointer;font-weight:600;font-size:16px;border:none;border-radius:12px;color:#fff;transition:0.3s;}
button:active{transform:scale(0.98);}
#registerBtn{background:linear-gradient(45deg, #2575fc, #6a11cb);width:100%;padding:16px;margin:10px 0;box-shadow:0 5px 15px rgba(37, 117, 252, 0.4);}
#loginBtn{background:linear-gradient(45deg, #6a11cb, #2575fc);width:100%;padding:16px;margin:10px 0;box-shadow:0 5px 15px rgba(106, 17, 203, 0.4);}
#status{text-align:center;font-weight:600;color:#ff4757;margin-bottom:10px;}
#appPage{display:none;min-height:100vh;background:#f8f9fd;position:relative;max-width:480px;margin:0 auto;box-shadow:0 0 20px rgba(0,0,0,0.05);}

header{padding:20px;font-size:22px;font-weight:700;text-align:center;background:#fff;position:sticky;top:0;z-index:90;box-shadow:0 2px 10px rgba(0,0,0,0.05);color:#2575fc;}
main{padding:20px;padding-bottom:120px;font-size:16px}

/* Toggle Link Style */
.toggle-auth{text-align:center; margin-top:15px; font-size:14px; color:#888;}
.toggle-auth span{color:#2575fc; cursor:pointer; font-weight:600;}

/* Password View Feature */
.password-wrapper { position: relative; width: 100%; }
.password-wrapper input { padding-right: 45px; } 
.toggle-eye { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 18px; color: #aaa; }

/* --- HOME PAGE NEW STYLES --- */
.home-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.user-info h3 { margin: 0; font-size: 20px; color: #222; font-weight: 700; }
.user-info span { font-size: 14px; color: #888; font-weight: 500; }
.notif-icon { background: #fff; padding: 10px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.05); font-size: 18px; }

/* Balance Card (ATM Style) */
.balance-card { 
    background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%); 
    color: white; 
    padding: 25px; 
    border-radius: 22px; 
    margin-bottom: 30px; 
    box-shadow: 0 15px 30px rgba(37, 117, 252, 0.3); 
    position: relative; 
    overflow: hidden; 
}
.balance-card::before {
    content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px;
    background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none;
}
.balance-card h4 { margin: 0; font-size: 14px; opacity: 0.9; font-weight: 500; }
.balance-card h1 { margin: 12px 0 25px 0; font-size: 38px; font-weight: 700; letter-spacing: 1px;}
.balance-actions { display: flex; gap: 12px; }
.balance-btn { 
    background: rgba(255,255,255,0.25); 
    border: 1px solid rgba(255,255,255,0.3);
    padding: 10px 20px; 
    border-radius: 12px; 
    color: #fff; 
    font-size: 14px; 
    font-weight: 600;
    cursor: pointer; 
    backdrop-filter: blur(5px);
    flex: 1;
}
.balance-btn:hover { background: rgba(255,255,255,0.35); }

/* Grid Actions */
.section-title { font-size: 16px; font-weight: 700; color: #444; margin: 0 0 15px 5px; }
.action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
.action-card { 
    background: #fff; 
    padding: 20px; 
    border-radius: 18px; 
    text-align: center; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.04); 
    cursor: pointer; 
    transition: 0.3s; 
    border: 1px solid #f0f0f0;
}
.action-card:active { transform: scale(0.95); }
.action-icon { font-size: 32px; margin-bottom: 10px; display: block; }
.action-title { font-weight: 600; font-size: 15px; color: #555; }

/* Slider Styles */
.slider-container{position:relative;width:100%;margin:0 auto;border-radius:18px;overflow:hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.06);}
.slider-slide{display:none;width:100%;cursor:pointer;color:#fff;font-weight:600;font-size:18px;padding:40px 20px;text-align:center;box-sizing:border-box;}
.slider-slide .logo{display:inline-block;width:40px;height:40px;margin-bottom:10px;border-radius:50%;background:#fff;color:#2575fc;line-height:40px;font-size:22px;box-shadow:0 4px 10px rgba(0,0,0,0.2);}

/* FOOTER */
footer{position:fixed;bottom:0;width:100%;max-width:480px;height:80px;background:#fff;border-top:1px solid #eee;display:flex;justify-content:space-around;align-items:center;padding-bottom:10px;z-index:100; left: 50%; transform: translateX(-50%); box-shadow: 0 -5px 20px rgba(0,0,0,0.03);}
footer button{background:transparent;border:none;border-radius:0;width:auto;height:auto;font-size:12px;font-weight:600;color:#999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:0.3s;}
footer button span{font-size:24px;margin-bottom:5px; transition: 0.3s;}
footer button.active{color:#2575fc;}
footer button.active span{transform:translateY(-5px);}

/* Wallet & Page styles */
#walletBalance{font-size:42px;font-weight:700;color:#2575fc;text-align:center;margin:30px 0 10px 0;}
.withdraw-history{margin-top:25px;border-top:1px solid #eee;padding-top:20px;}
.withdraw-item{margin-bottom:15px;padding:20px;border-radius:18px;background:#fff;color:#333;box-shadow:0 5px 15px rgba(0,0,0,0.05); font-weight:500; font-size:16px; border-left: 5px solid #2575fc;}
.ad-container { margin-bottom: 25px; text-align: center; }

/* Banner Ads Styling */
.banner-ad-box { 
    background: #eef4ff; 
    border: 2px dashed #2575fc; 
    border-radius: 18px; 
    padding: 20px; 
    min-height: 250px; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
    box-sizing: border-box;
}
/* Fixed Heights for Iframe Containers */
#ad-slot-300-250 { width: 300px; height: 250px; margin: 0 auto; display: block; background: #fff; }
#ad-slot-320-50 { width: 320px; height: 50px; margin: 0 auto; display: block; background: #fff; }

.banner-small {
    min-height: 80px !important;
    padding: 15px !important;
    margin-top: 15px;
    border-color: #6a11cb;
    background: #f3e5f5;
}

.ad-reward-tag { position: absolute; top: -12px; right: 20px; background: #ffd700; color: #000; padding: 6px 15px; font-weight: 700; border-radius: 20px; font-size: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.smart-link-box { background: #fff; border-radius: 16px; padding: 18px; margin: 12px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #f0f0f0;}

/* Privacy Modal */
.modal-bg{display:none;position:fixed;top:0; left:0; width:100%; height:100%;background:rgba(0,0,0,0.6);justify-content:center; align-items:center;z-index:9999;backdrop-filter: blur(5px);}
.modal-content{background:#fff; padding:30px; border-radius:24px;max-width:85%; max-height:80%; overflow-y:auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2);}

/* Overlay Blocker */
.click-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: rgba(255, 255, 255, 0.5); cursor: not-allowed; border-radius: 18px;}

/* Custom Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }

</style>
</head>
<body>

<div id="authPage" class="container">
  <div id="status"></div>

  <!-- Register Form -->
  <div id="registerBox">
    <h2 style="font-size: 28px; margin-bottom: 5px;">Create Account</h2>
    <p style="text-align: center; color: #777; margin-bottom: 25px;">Start earning today!</p>
    <input id="regName" placeholder="Full Name">
    <input id="regEmail" placeholder="Email Address">
    
    <div class="password-wrapper">
      <input id="regPassword" type="password" placeholder="Password">
      <span class="toggle-eye" onclick="togglePassword('regPassword', this)">üôà</span>
    </div>
    
    <button id="registerBtn" onclick="register()">Register Now</button>
    <div class="toggle-auth">Already have an account? <span onclick="showLogin()">Login</span></div>
  </div>

  <!-- Login Form -->
  <div id="loginBox" style="display:none;">
    <h2 style="font-size: 28px; margin-bottom: 5px;">Welcome Back</h2>
    <p style="text-align: center; color: #777; margin-bottom: 25px;">Login to your dashboard</p>
    <input id="loginEmail" placeholder="Email Address">
    
    <div class="password-wrapper">
      <input id="loginPassword" type="password" placeholder="Password">
      <span class="toggle-eye" onclick="togglePassword('loginPassword', this)">üôà</span>
    </div>
    
    <button id="loginBtn" onclick="login()">Login</button>
    <div class="toggle-auth">Don't have an account? <span onclick="showRegister()">Register</span></div>
  </div>
</div>

<div id="appPage">
<header id="mainHeader">Earn Vexa üí≤</header>
<main id="mainContent"></main>

<footer>
  <button id="homeBtn" class="active" onclick="showPage('home')"><span>üè†</span>Home</button>
  <button id="earnBtn" onclick="showPage('earn')"><span>üöÄ</span>Earn</button>
  <button id="walletBtn" onclick="showPage('wallet')"><span>üëõ</span>Wallet</button>
  <button id="profileBtn" onclick="showPage('profile')"><span>üë§</span>Profile</button>
</footer>
</div>

<!-- Privacy Modal -->
<div id="privacyModal" class="modal-bg">
  <div class="modal-content">
    <h2 style="margin-top:0">Privacy Policy</h2>
    <p style="line-height: 1.6; color: #555;">
      This website collects only your name and email for authentication purposes. Your balance, withdrawals, and account information are securely stored. We do not share, sell, or disclose your personal data to any unauthorized third parties.<br><br>
      We may use cookies or analytics tools to improve user experience. By using this website, you agree to our privacy terms.
    </p>
    <button onclick="closePrivacy()" style="background:#2575fc; padding:12px; width:100%; border-radius:12px; margin-top:15px;">Close</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCHngO1wEvo-L1Grc7tGlT-uDN1lXmIlVI",
  authDomain: "earn-vexa.firebaseapp.com",
  projectId: "earn-vexa",
  storageBucket: "earn-vexa.firebasestorage.app",
  messagingSenderId: "385593303650",
  appId: "1:385593303650:web:4595e3443d978cd9a3273b"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let userData = {};
let withdrawHistory = [];
let userDocListener = null;
let bannerBlurListener = null; 

const TELEGRAM_BOT_TOKEN = "8052078728:AAGk2zKjovKSHgKnqPCfaDVb1-fGeURa3Cw";
const TELEGRAM_CHAT_ID = "-100XXXXXXXXXX";

const statusEl = document.getElementById("status");

function togglePassword(inputId, eyeIcon) {
  const passwordInput = document.getElementById(inputId);
  if (passwordInput.type === "password") {
    passwordInput.type = "text";
    eyeIcon.innerText = "üëÅÔ∏è"; 
  } else {
    passwordInput.type = "password";
    eyeIcon.innerText = "üôà"; 
  }
}

function showLogin() {
  document.getElementById("registerBox").style.display = "none";
  document.getElementById("loginBox").style.display = "block";
  statusEl.textContent = "";
}
function showRegister() {
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("registerBox").style.display = "block";
  statusEl.textContent = "";
}

async function register(){  
  statusEl.textContent = "";
  const name = regName.value.trim();
  const email = regEmail.value.trim();
  const password = regPassword.value;

  if(!name || !email || !password){ 
    statusEl.textContent = "‚ùå All fields are required!"; 
    return; 
  }
  if(!email.endsWith("@gmail.com")){ 
    statusEl.textContent = "‚ùå Only Gmail (@gmail.com) is allowed!"; 
    return; 
  }
  if(password.length < 6){
    statusEl.textContent = "‚ùå Password should be at least 6 characters";
    return;
  }

  try{
    const res = await auth.createUserWithEmailAndPassword(email, password);
    await db.collection("users").doc(res.user.uid).set({
      name: name, email: email, password: password, balance: "0", isBanned: false
    });
  }catch(e){ 
    if(e.code === 'auth/email-already-in-use'){
      statusEl.textContent = "‚ùå Email already registered!";
    } else {
      statusEl.textContent = "‚ùå Error: " + e.message; 
    }
  }
}

async function login(){
  statusEl.textContent="";
  try{ await auth.signInWithEmailAndPassword(loginEmail.value,loginPassword.value); } 
  catch(e){ statusEl.textContent="‚ùå Login failed! incorrect email or password."; }
}

async function loadApp(user){
  authPage.style.display="none";
  appPage.style.display="block";
  if(userDocListener) userDocListener();
  userDocListener = db.collection("users").doc(user.uid).onSnapshot((doc) => {
      if(doc.exists){
          userData = doc.data();
          if(userData.isBanned === true){ alert("üö´ Account Banned!"); logout(); return; }
          userData.email = user.email;
          const wb = document.getElementById("walletBalance");
          if(wb) wb.innerText = (userData.balance || 0) + " USDT";
          
          const hb = document.getElementById("homeBalanceDisplay");
          if(hb) hb.innerText = parseFloat(userData.balance || 0).toFixed(4);
      }
  });
  try {
      const historySnap = await db.collection("withdraw_requests").where("uid","==",user.uid).get();
      withdrawHistory = historySnap.docs.map(d=>d.data());
  } catch(e) { console.log("Withdraw History Load Error:", e); }
  showPage("home");
}

let slideIndex = 0;
const slidesData = [
  {text:"Join Telegram Channel", sub:"For Payment Proofs", link:"https://t.me/Mahar821", color:"linear-gradient(135deg, #2575fc, #6a11cb)", logo:"üì¢"},
  {text:"Need Help?", sub:"Contact Support", link:"https://t.me/earnvexa", color:"linear-gradient(135deg, #43e97b, #38f9d7)", logo:"üí¨"}
];
function showSlide(){
  const sliderContainer = document.querySelector(".slider-container");
  if(!sliderContainer) return;
  sliderContainer.innerHTML = '';
  const slide = document.createElement('div');
  slide.className = "slider-slide";
  slide.style.background = slidesData[slideIndex].color;
  slide.innerHTML = `<span class="logo">${slidesData[slideIndex].logo}</span><br>${slidesData[slideIndex].text}<br><small style="font-weight:400; font-size:14px; opacity:0.9">${slidesData[slideIndex].sub}</small>`;
  slide.onclick = ()=>{ window.open(slidesData[slideIndex].link,'_blank'); };
  sliderContainer.appendChild(slide);
  slide.style.display = "block";
  slideIndex = (slideIndex+1)%slidesData.length;
}
setInterval(showSlide, 3500);

async function processReward(taskId, rewardAmount) {
    const today = new Date().toISOString().split('T')[0];
    const uid = auth.currentUser.uid;
    const taskRef = db.collection("user_ads").doc(uid);
    
    try {
        const currentBalance = parseFloat(userData.balance || 0);
        const newBalance = (currentBalance + rewardAmount).toFixed(7);
        await db.collection("users").doc(uid).update({ balance: newBalance.toString() });
        let updateObj = {};
        updateObj[taskId] = today;
        await taskRef.set(updateObj, { merge: true });
        return true; 
    } catch(e) { console.error(e); return false; }
}

async function handleEarn(taskId, rewardAmount, url) {
    const today = new Date().toISOString().split('T')[0];
    const uid = auth.currentUser.uid;
    const doc = await db.collection("user_ads").doc(uid).get();
    const data = doc.exists ? doc.data() : {};
    
    if (data[taskId] === today) {
        alert("‚ùå Already claimed today! Come back tomorrow");
        return;
    }
    const success = await processReward(taskId, rewardAmount);
    if(success) {
        window.open(url, '_blank');
        alert(`‚úÖ Success! You earned ${rewardAmount} USDT.`);
    }
}

async function showPage(p){
  document.querySelectorAll("footer button").forEach(b=>b.classList.remove("active"));
  document.getElementById("mainHeader").style.display = (p === "home") ? "none" : "block"; 
  
  if(bannerBlurListener) { window.removeEventListener('blur', bannerBlurListener); bannerBlurListener = null; }

  // --- HOME PAGE DASHBOARD ---
  if(p==="home"){
    let currentBal = userData.balance ? parseFloat(userData.balance).toFixed(4) : "0.0000";
    
    mainContent.innerHTML=`
      <!-- Header -->
      <div class="home-header">
        <div class="user-info">
           <h3>Hi, ${userData.name || 'User'} üëã</h3>
           <span>Ready to earn today?</span>
        </div>
        <div class="notif-icon" onclick="window.open('https://t.me/Mahar821','_blank')">üîî</div>
      </div>

      <!-- Balance Card -->
      <div class="balance-card">
         <h4>Total Balance</h4>
         <h1><span id="homeBalanceDisplay">${currentBal}</span> <span style="font-size:18px">USDT</span></h1>
         <div class="balance-actions">
           <button class="balance-btn" onclick="showPage('earn')">Start Earn</button>
           <button class="balance-btn" onclick="showPage('wallet')">Withdraw</button>
         </div>
      </div>

      <!-- Quick Actions Grid -->
      <div class="section-title">Quick Actions</div>
      <div class="action-grid">
         <div class="action-card" onclick="showPage('earn')">
           <span class="action-icon" style="color:#2575fc">üöÄ</span>
           <div class="action-title">Tasks</div>
         </div>
         <div class="action-card" onclick="showPage('wallet')">
           <span class="action-icon" style="color:#6a11cb">üëõ</span>
           <div class="action-title">Wallet</div>
         </div>
         <div class="action-card" onclick="window.open('https://t.me/Mahar821','_blank')">
           <span class="action-icon" style="color:#0088cc">üì¢</span>
           <div class="action-title">Telegram</div>
         </div>
         <div class="action-card" onclick="openPrivacy()">
           <span class="action-icon" style="color:#ff9f43">üõ°Ô∏è</span>
           <div class="action-title">Policy</div>
         </div>
      </div>

      <!-- Slider (News) -->
      <div class="section-title">Announcements</div>
      <div class="slider-container"></div>
      
      <div style="height:20px;"></div>
    `;
    homeBtn.classList.add("active");
    slideIndex=0;
    showSlide();
  }

  // --- EARN PAGE MODIFIED ---
  if(p==="earn"){
    mainContent.innerHTML=`
      <div class="ad-container" style="margin-top:10px;">
        <!-- Banner 1 (300x250) -->
        <div class="banner-ad-box" id="bannerWrapper">
            <div class="ad-reward-tag">Earn 0.00205 USDT</div>
            <div id="ad-slot-300-250"></div>
            <div id="bannerOverlay" class="click-overlay"></div>
        </div>

        <!-- Banner 2 (320x50) -->
        <div class="banner-ad-box banner-small" id="bannerWrapper2">
            <div class="ad-reward-tag" style="background:#00d2d3; color:#fff;">Earn 0.00205 USDT</div>
            <div id="ad-slot-320-50"></div>
            <div id="bannerOverlay2" class="click-overlay"></div>
        </div>
      </div>

      <!-- Smart Links List -->
      <div class="section-title">Direct Links</div>
      
      <div class="smart-link-box" onclick="handleEarn('smart1', 0.0008197, 'https://www.effectivegatecpm.com/q5tr5extmy?key=d3bd60a33be82ecf91d6d22b59cd9765')">
        <div style="font-weight:700;">Ad link 1</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart2', 0.0008197, 'https://www.effectivegatecpm.com/kxdppwwruj?key=cc18e71b22c9889bc375099a9f4ce46f')">
        <div style="font-weight:700;">Ad link 2</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart3', 0.0008197, 'https://www.effectivegatecpm.com/qjy3qs3cu?key=51b052bab3e5366ca575842e68a8c808')">
        <div style="font-weight:700;">Ad link 3</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart4', 0.0008197, 'https://www.effectivegatecpm.com/cn5p8241vw?key=57ee98cb7cb7b1ac8a11dbe9802977f9')">
        <div style="font-weight:700;">Ad link 4</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart5', 0.0008197, 'https://www.effectivegatecpm.com/ar8rd00b?key=263a5d556e491df174d3d1b33ef777e8')">
        <div style="font-weight:700;">Ad link 5</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart6', 0.0008197, 'https://www.effectivegatecpm.com/h5k34gs4?key=2c6382d277deeb2dc4b14d58d7208caa')">
        <div style="font-weight:700;">Ad link 6</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart7', 0.0008197, 'https://www.effectivegatecpm.com/pu2a046u?key=65d4bf395068f08f4721e90b40c0eb0d')">
        <div style="font-weight:700;">Ad link 7</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart8', 0.0008197, 'https://www.effectivegatecpm.com/wv4q5gpa5?key=513d875d8b53c8e14716f32640770dcf')">
        <div style="font-weight:700;">Ad link 8</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart9', 0.0008197, 'https://www.effectivegatecpm.com/aekvgnemc?key=8d627e2df3a16e8b942ff76f54f98467')">
        <div style="font-weight:700;">Ad link 9</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart10', 0.0008197, 'https://www.effectivegatecpm.com/ezjisqjn10?key=affe0d1d6b387bc3b6cb9e71a50cb04b')">
        <div style="font-weight:700;">Ad link 10</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
       <div class="smart-link-box" onclick="handleEarn('smart11', 0.0008197, 'https://www.effectivegatecpm.com/hmx00h1i6?key=bd643fed44ee2888b5bf4de574834539')">
        <div style="font-weight:700;">Ad link 11</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart12', 0.0008197, 'https://www.effectivegatecpm.com/gpfqnia5i?key=a25fb881eb076c4e3b8f66007af718a3')">
        <div style="font-weight:700;">Ad link 12</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart13', 0.0008197, 'https://www.effectivegatecpm.com/rtnc5tpipv?key=496b41f10468a4090855d669ea492d7f')">
        <div style="font-weight:700;">Ad link 13</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart14', 0.0008197, 'https://www.effectivegatecpm.com/kqx8gwqs6?key=1eace66dadd273bf954f3e1089333d00')">
        <div style="font-weight:700;">Ad link 14</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
      <div class="smart-link-box" onclick="handleEarn('smart15', 0.0008197, 'https://www.effectivegatecpm.com/jt5tz4bsk?key=c8e7b269a5a391bc152ab993558f079b')">
        <div style="font-weight:700;">Ad link 15</div>
        <div style="color:#28a745; font-weight:700;">0.0008197 USDT</div>
      </div>
    `;
    earnBtn.classList.add("active");

    // --- NEW: Iframe Based Injection for Conflict-Free Loading ---
    function loadAdInIframe(id, key, w, h) {
        const container = document.getElementById(id);
        if(!container) return;
        container.innerHTML = ''; // Clean

        const iframe = document.createElement('iframe');
        iframe.style.width = w + "px";
        iframe.style.height = h + "px";
        iframe.style.border = "none";
        iframe.style.overflow = "hidden";
        iframe.scrolling = "no";
        container.appendChild(iframe);

        // Write the ad script directly inside the iframe
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(`<html><body style='margin:0;padding:0;overflow:hidden;'>`);
        doc.write(`<script type="text/javascript">
            atOptions = { 'key' : '${key}', 'format' : 'iframe', 'height' : ${h}, 'width' : ${w}, 'params' : {} };
        <\/script>`);
        doc.write(`<script type="text/javascript" src="https://www.highperformanceformat.com/${key}/invoke.js"><\/script>`);
        doc.write(`</body></html>`);
        doc.close();
    }

    // Load Ads into Isolated Iframes
    loadAdInIframe('ad-slot-300-250', '290468ba31574258b12173a3560e2bc8', 300, 250);
    loadAdInIframe('ad-slot-320-50', 'e23699bfd848edbee2eb67dbd5822f42', 320, 50);
    
    // --- BANNER LOGIC ---
    const today = new Date().toISOString().split('T')[0];
    const doc = await db.collection("user_ads").doc(auth.currentUser.uid).get();
    const data = doc.exists ? doc.data() : {};

    // Elements
    const wrapper1 = document.getElementById('bannerWrapper');
    const overlay1 = document.getElementById('bannerOverlay');
    const wrapper2 = document.getElementById('bannerWrapper2');
    const overlay2 = document.getElementById('bannerOverlay2');

    // Status Flags
    let claimed1 = (data['banner1'] === today);
    let claimed2 = (data['banner2'] === today);

    // Hover Tracking
    let isHovering1 = false;
    let isHovering2 = false;

    // --- SETUP BANNER 1 ---
    const enableBlocker1 = () => {
        overlay1.style.display = 'block'; 
        overlay1.onclick = (e) => { e.stopPropagation(); alert("‚ùåÔ∏è Already claimed today! Come back tomorrow. "); };
        claimed1 = true;
    };
    if(claimed1) { enableBlocker1(); } else {
        overlay1.style.display = 'none';
        wrapper1.onmouseover = () => isHovering1 = true;
        wrapper1.onmouseout = () => isHovering1 = false;
    }

    // --- SETUP BANNER 2 ---
    const enableBlocker2 = () => {
        overlay2.style.display = 'block'; 
        overlay2.onclick = (e) => { e.stopPropagation(); alert("‚ùå Already claimed today! Come back tomorrow. "); };
        claimed2 = true;
    };
    if(claimed2) { enableBlocker2(); } else {
        overlay2.style.display = 'none';
        wrapper2.onmouseover = () => isHovering2 = true;
        wrapper2.onmouseout = () => isHovering2 = false;
    }

    // --- SHARED BLUR LISTENER (Detects Clicks inside Iframes) ---
    bannerBlurListener = async function() {
        // Handle Banner 1 Click
        if(isHovering1 && !claimed1) {
            await processReward('banner1', 0.00205);
            enableBlocker1();
            isHovering1 = false; // Prevent double trigger
            setTimeout(() => { alert(`‚úÖ Success! You earned 0.00205 USDT.`); }, 1000);
        }

        // Handle Banner 2 Click
        if(isHovering2 && !claimed2) {
            await processReward('banner2', 0.00205); 
            enableBlocker2();
            isHovering2 = false; // Prevent double trigger
            setTimeout(() => { alert(`‚úÖ Success! You earned 0.00205 USDT.`); }, 1000);
        }
    };
    window.addEventListener('blur', bannerBlurListener);
  }

  if(p==="wallet"){
    let historyHtml = withdrawHistory.map(h => {
        return `<div class="withdraw-item">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-weight:700; color:#2575fc">${h.method}</span>
                <span style="font-size:14px; background:#eee; padding:2px 8px; border-radius:6px; color:#555;">${h.status}</span>
            </div>
            <div style="font-size:24px; font-weight:700;">${h.amount} USDT</div>
            <div style="font-size:13px; color:#777; margin-top:5px;">To: ${h.account}</div>
        </div>`;
    }).join("");
    
    mainContent.innerHTML=`
      <div style="text-align:center;">
          <h2 style="margin:0; font-size:20px; color:#555;">Current Balance</h2>
          <div id="walletBalance">${userData.balance || 0} USDT</div>
      </div>

      <div style="background:#fff; padding:20px; border-radius:20px; box-shadow:0 5px 20px rgba(0,0,0,0.05);">
        <h3 style="margin-top:0; color:#444;">Withdraw Money</h3>
        <select id="method">
            <option value="bKash">üí∏ Bkash</option>
            <option value="Nagad">üí∂ Nagad</option>
            <option value="Binance">üí≤ Binance</option>
        </select>
        <input id="account" placeholder="Wallet Address / Number">
        <input id="amount" placeholder="Amount (Min 0.50)" type="number">
        <button onclick="withdraw()" style="width:100%; padding:18px; background:#2575fc; font-size:18px; border-radius:12px; margin-top:10px;">Request Withdraw</button>
      </div>

      <div class="withdraw-history">
          <h4 style="margin:0 0 15px 0; color:#555;">Recent Transactions</h4>
          ${historyHtml||"<div style='text-align:center;color:#999;padding:20px;'>No transactions yet</div>"}
      </div>`;
    walletBtn.classList.add("active");
  }

  if(p==="profile"){
    mainContent.innerHTML=`
      <div style="text-align:center; padding:30px 0;">
         <div style="width:80px; height:80px; background:#eef4ff; color:#2575fc; font-size:40px; line-height:80px; border-radius:50%; margin:0 auto 15px auto;">üë§</div>
         <h2 style="margin:0;">${userData.name}</h2>
         <p style="color:#777; margin:5px 0;">${userData.email}</p>
      </div>

      <div style="background:#fff; border-radius:18px; overflow:hidden; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
          <div style="padding:18px; border-bottom:1px solid #f0f0f0; display:flex; align-items:center;">
             <span style="font-size:20px; margin-right:15px;">üîí</span> Change Password
          </div>
          <div style="padding:18px; border-bottom:1px solid #f0f0f0; display:flex; align-items:center; cursor:pointer;" onclick="window.open('https://t.me/Mahar821','_blank')">
             <span style="font-size:20px; margin-right:15px;">üí¨</span> Support
          </div>
          <div style="padding:18px; cursor:pointer; color:red; display:flex; align-items:center;" onclick="logout()">
             <span style="font-size:20px; margin-right:15px;">üö™</span> Logout
          </div>
      </div>
    `;
    profileBtn.classList.add("active");
  }
}

async function withdraw(){
  const methodEl = document.getElementById("method");
  const accountEl = document.getElementById("account");
  const amountEl = document.getElementById("amount");
  let reqAmount = parseFloat(amountEl.value);
  let currentBalance = parseFloat(userData.balance || 0);

  if(!methodEl.value || !accountEl.value || !reqAmount){ alert("‚ùå All fields required!"); return; }
  if(reqAmount <= 0){ alert("‚ùå Invalid Amount!"); return; }
  if(reqAmount > currentBalance){ alert("‚ùå Insufficient Balance!"); return; }

  if(!confirm(`Withdraw ${reqAmount} USDT to ${methodEl.value}?`)) return;
  try{
    let newBalance = (currentBalance - reqAmount).toFixed(7);
    const newWithdrawRequest = {
      uid: auth.currentUser.uid, method: methodEl.value, account: accountEl.value, amount: reqAmount.toString(), status: "Pending", time: new Date()
    };
    
    await db.collection("users").doc(auth.currentUser.uid).update({ balance: newBalance.toString() });
    await db.collection("withdraw_requests").add(newWithdrawRequest);
    
    const message=`üí∞ New Withdraw Request\nUser: ${userData.name}\nMethod: ${methodEl.value}\nAccount: ${accountEl.value}\nAmount: ${reqAmount} USDT`;
    fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}`);
    alert("‚úÖ Request Submitted!");
    
    const historySnap = await db.collection("withdraw_requests").where("uid","==",auth.currentUser.uid).get();
    withdrawHistory = historySnap.docs.map(d=>d.data());
    showPage("wallet");
  } catch(e){ alert("‚ùå Failed: " + e.message); console.error(e); }
}

function logout(){ auth.signOut(); location.reload(); }
function openPrivacy(){ document.getElementById("privacyModal").style.display="flex"; }
function closePrivacy(){ document.getElementById("privacyModal").style.display="none"; }

let appLoaded = false;
auth.onAuthStateChanged(u=>{
  if(u){ if(!appLoaded){ appLoaded = true; loadApp(u); } 
  } 
  else { appLoaded = false; authPage.style.display="block"; appPage.style.display="none"; }
});
</script>
</body>
</html>
